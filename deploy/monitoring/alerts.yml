# Prometheus alerting rules for Deep Research MCP

groups:
  # ============================================================================
  # System Health Alerts
  # ============================================================================
  - name: deep_research_mcp_system
    rules:
      - alert: DeepResearchMCPDown
        expr: up{job="deep-research-mcp"} == 0
        for: 1m
        labels:
          severity: critical
          service: deep-research-mcp
        annotations:
          summary: "Deep Research MCP service is down"
          description: "The Deep Research MCP service has been down for more than 1 minute."
          runbook_url: "https://docs.deepresearch.com/runbooks/service-down"

      - alert: DeepResearchMCPHealthCheckFailing
        expr: |
          (
            up{job="deep-research-mcp-health"} == 0
            or
            rate(http_requests_total{job="deep-research-mcp-health", status="200"}[5m]) == 0
          )
        for: 2m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Deep Research MCP health check failing"
          description: "Health check endpoint is not responding or returning errors."

      - alert: HighMemoryUsage
        expr: |
          (
            container_memory_usage_bytes{name=~"deep-research-.*"} / 
            container_spec_memory_limit_bytes{name=~"deep-research-.*"} * 100
          ) > 85
        for: 5m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% for {{ $labels.name }} container."

      - alert: HighCPUUsage
        expr: |
          (
            rate(container_cpu_usage_seconds_total{name=~"deep-research-.*"}[5m]) * 100
          ) > 80
        for: 10m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for {{ $labels.name }} container for more than 10 minutes."

  # ============================================================================
  # Application Performance Alerts
  # ============================================================================
  - name: deep_research_mcp_performance
    rules:
      - alert: HighResponseTime
        expr: deep_research_mcp:response_time_p95 > 30
        for: 5m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s, which is above the 30s threshold."

      - alert: VeryHighResponseTime
        expr: deep_research_mcp:response_time_p95 > 60
        for: 2m
        labels:
          severity: critical
          service: deep-research-mcp
        annotations:
          summary: "Very high response time detected"
          description: "95th percentile response time is {{ $value }}s, which is critically high."

      - alert: HighErrorRate
        expr: deep_research_mcp:error_rate > 0.05
        for: 5m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}, which is above 5%."

      - alert: CriticalErrorRate
        expr: deep_research_mcp:error_rate > 0.20
        for: 2m
        labels:
          severity: critical
          service: deep-research-mcp
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}, which is critically high."

      - alert: LowResearchSuccessRate
        expr: deep_research_mcp:research_success_rate < 0.80
        for: 10m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Low research success rate"
          description: "Research success rate is {{ $value | humanizePercentage }}, below 80%."

  # ============================================================================
  # Resource and Infrastructure Alerts
  # ============================================================================
  - name: deep_research_mcp_resources
    rules:
      - alert: DiskSpaceRunningLow
        expr: |
          (
            (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100
          ) < 20
        for: 5m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Disk space running low"
          description: "Available disk space is below 20% ({{ $value }}% remaining)."

      - alert: DiskSpaceCriticallyLow
        expr: |
          (
            (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100
          ) < 10
        for: 1m
        labels:
          severity: critical
          service: deep-research-mcp
        annotations:
          summary: "Disk space critically low"
          description: "Available disk space is critically low ({{ $value }}% remaining)."

      - alert: TooManyRestarts
        expr: increase(container_start_time_seconds{name=~"deep-research-.*"}[1h]) > 3
        for: 0m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Container restarting frequently"
          description: "Container {{ $labels.name }} has restarted {{ $value }} times in the last hour."

      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 2m
        labels:
          severity: warning
          service: deep-research-mcp
          component: redis
        annotations:
          summary: "Redis service is down"
          description: "Redis cache service has been down for more than 2 minutes. This may affect performance."

  # ============================================================================
  # API and External Dependencies Alerts
  # ============================================================================
  - name: deep_research_mcp_dependencies
    rules:
      - alert: HighAPIErrorRate
        expr: |
          (
            rate(external_api_requests_total{status=~"4..|5.."}[5m]) /
            rate(external_api_requests_total[5m])
          ) > 0.10
        for: 5m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "High external API error rate"
          description: "Error rate for external APIs is {{ $value | humanizePercentage }}, above 10%."

      - alert: APIRateLimitHit
        expr: increase(external_api_rate_limit_errors_total[5m]) > 5
        for: 0m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "API rate limit exceeded"
          description: "API rate limit has been exceeded {{ $value }} times in the last 5 minutes for {{ $labels.provider }}."

      - alert: LowAPIQuota
        expr: external_api_quota_remaining < 100
        for: 1m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Low API quota remaining"
          description: "API quota for {{ $labels.provider }} is low: {{ $value }} requests remaining."

  # ============================================================================
  # Security and Anomaly Detection Alerts
  # ============================================================================
  - name: deep_research_mcp_security
    rules:
      - alert: UnusualRequestVolume
        expr: |
          (
            rate(http_requests_total[5m]) > 
            (avg_over_time(rate(http_requests_total[5m])[1h:5m]) * 3)
          )
        for: 10m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Unusual request volume detected"
          description: "Request volume is 3x higher than the hourly average: {{ $value }} req/s."

      - alert: TooManyFailedRequests
        expr: increase(http_requests_total{status=~"4..|5.."}[1m]) > 50
        for: 2m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Too many failed requests"
          description: "{{ $value }} failed requests in the last minute, indicating potential issues."

      - alert: LongRunningResearchTasks
        expr: |
          (
            time() - research_task_start_time > 3600
          )
        for: 0m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Long-running research task detected"
          description: "Research task {{ $labels.task_id }} has been running for over 1 hour."

  # ============================================================================
  # Business Logic Alerts
  # ============================================================================
  - name: deep_research_mcp_business
    rules:
      - alert: NoResearchRequestsReceived
        expr: increase(deep_research_requests_total[1h]) == 0
        for: 0m
        labels:
          severity: info
          service: deep-research-mcp
        annotations:
          summary: "No research requests received"
          description: "No research requests have been received in the last hour. This might indicate a problem with clients or low usage."

      - alert: HighCostPerHour
        expr: increase(api_cost_total[1h]) > 50
        for: 0m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "High API cost detected"
          description: "API costs have exceeded $50 in the last hour: ${{ $value }}."

      - alert: QueueBacklogGrowing
        expr: research_queue_size > 20
        for: 5m
        labels:
          severity: warning
          service: deep-research-mcp
        annotations:
          summary: "Research queue backlog growing"
          description: "Research queue has {{ $value }} pending items, indicating potential performance issues."