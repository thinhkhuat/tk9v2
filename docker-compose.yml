version: "3.8"

services:
  # ============================================================================
  # TK9 Backend - FastAPI on port 12689
  # ============================================================================
  tk9-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        BUILD_VERSION: ${BUILD_VERSION:-v2.0.0}
    image: tk9-backend:${TAG:-latest}
    container_name: tk9-backend
    restart: unless-stopped

    environment:
      # Server
      - HOST=0.0.0.0
      - PORT=12689
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-false}

      # AI Providers (7-agent system)
      - PRIMARY_LLM_PROVIDER=${PRIMARY_LLM_PROVIDER:-google_gemini}
      - PRIMARY_LLM_MODEL=${PRIMARY_LLM_MODEL:-gemini-2.5-flash}
      - PRIMARY_SEARCH_PROVIDER=${PRIMARY_SEARCH_PROVIDER:-brave}

      # API Keys
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Research Config
      - RESEARCH_LANGUAGE=${RESEARCH_LANGUAGE:-vi}
      - SEARCH_COUNTRY=${SEARCH_COUNTRY:-VN}
      - LLM_STRATEGY=${LLM_STRATEGY:-primary_only}
      - SEARCH_STRATEGY=${SEARCH_STRATEGY:-primary_only}

      # BRAVE Search
      - RETRIEVER=${RETRIEVER:-custom}
      - RETRIEVER_ENDPOINT=${RETRIEVER_ENDPOINT:-https://brave-local-provider.local}

      # CORS (allow frontend)
      - CORS_ORIGINS=http://localhost:8592,http://192.168.2.22:8592,https://tk9v2.thinhkhuat.com,https://tk9.thinhkhuat.com

      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}

    ports:
      - "12689:12689"

    volumes:
      - ./outputs:/app/outputs:rw
      - ./logs:/app/logs:rw
      - ./data:/app/data:rw
      - ./.env:/app/.env:ro

    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 8G
        reservations:
          cpus: "1.0"
          memory: 2G

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:12689/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - tk9-network

    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "5"

  # ============================================================================
  # TK9 Frontend - Vue 3 on port 8592
  # ============================================================================
  tk9-frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        BUILD_VERSION: ${BUILD_VERSION:-v2.0.0}
    image: tk9-frontend:${TAG:-latest}
    container_name: tk9-frontend
    restart: unless-stopped

    ports:
      - "8592:8592"

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8592/",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    networks:
      - tk9-network

    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

# ============================================================================
# Networks
# ============================================================================
networks:
  tk9-network:
    driver: bridge
    name: tk9-network
